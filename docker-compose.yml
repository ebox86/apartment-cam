services:
  cam-proxy:
    build: ./cam-proxy
    container_name: apartment-cam-proxy
    env_file:
      - .env
    ports:
      - "3001:3000"
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:3000/api/health').then(r=>{if(!r.ok) process.exit(1)}).catch(()=>process.exit(1))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      cam-net:
        aliases:
          - cam-proxy

  health-probe:
    build: ./cam-proxy
    container_name: apartment-health-probe
    depends_on:
      - cam-proxy
      - go2rtc
    environment:
      CAM_PROXY_HEALTH_URL: http://cam-proxy:3000/api/health
      GO2RTC_HEALTH_URL: http://go2rtc:1984/api/streams
      PROBE_INTERVAL_MS: "15000"
      PROBE_TIMEOUT_MS: "5000"
      PROBE_FAIL_LOG_MS: "60000"
    command: ["node", "health-probe.js"]
    restart: unless-stopped
    networks:
      - cam-net

  go2rtc:
    image: alexxit/go2rtc:1.9.13
    container_name: apartment-go2rtc
    env_file:
      - .env
    ports: ["1984:1984"]
    environment:
      AXIS_USER: ${CAMERA_USERNAME}
      AXIS_PASS: ${CAMERA_PASSWORD}
      AXIS_CAMERA: ${CAMERA_STREAM_ID:-1}
    volumes:
      - ./go2rtc/go2rtc.yaml:/config/go2rtc.yaml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:1984/api/streams"]
      interval: 30s
      timeout: 5s
      retries: 3
    command:
      - /bin/sh
      - -c
      - >
        export AXIS_HOST=$(echo "${CAMERA_HOST}" | sed -E 's~https?://~~' | sed -E 's~/$~~');
        exec go2rtc -config /config/go2rtc.yaml
    networks:
      cam-net:
        aliases:
          - go2rtc

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: apartment-cloudflared
    env_file:
      - .env
    depends_on:
      - go2rtc
      - cam-proxy
    volumes:
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      - ${TUNNEL_CREDENTIALS_FILE:-./cloudflared/tunnel.json}:/etc/cloudflared/tunnel.json:ro
      - ./cloudflared/cert.pem:/etc/cloudflared/cert.pem:ro
    restart: unless-stopped
    cap_add:
      - NET_RAW
    sysctls:
      net.ipv4.ping_group_range: "0 65535"
    command:
      - tunnel
      - --config
      - /etc/cloudflared/config.yml
      - --no-autoupdate
      - --protocol
      - http2
      - --credentials-file
      - /etc/cloudflared/tunnel.json
      - run
      - ${TUNNEL_NAME}
    networks:
      - cam-net

networks:
  cam-net:
    name: apartment-cam-net
